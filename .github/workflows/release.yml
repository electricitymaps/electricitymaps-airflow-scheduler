name: Release

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      dry_run:
        description: 'Dry run (skip publishing)'
        required: false
        type: boolean
        default: false

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Generate app token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Calculate next version
        id: version
        run: |
          BUMP_TYPE="${{ inputs.bump_type }}"
          LATEST=$(git tag -l 'v*' | sort -V | tail -n1 | sed 's/^v//')

          if [[ -z "$LATEST" ]]; then
            # No existing tags, start at 0.1.0
            case "$BUMP_TYPE" in
              major) VERSION="1.0.0" ;;
              minor) VERSION="0.1.0" ;;
              patch) VERSION="0.0.1" ;;
            esac
          else
            IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST"
            # Strip any suffix from patch (e.g., 1.0.0-beta -> 1.0.0)
            PATCH="${PATCH%%-*}"

            case "$BUMP_TYPE" in
              major) VERSION="$((MAJOR + 1)).0.0" ;;
              minor) VERSION="$MAJOR.$((MINOR + 1)).0" ;;
              patch) VERSION="$MAJOR.$MINOR.$((PATCH + 1))" ;;
            esac
          fi

          TAG="v$VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "Bumping $BUMP_TYPE: $LATEST -> $VERSION"

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Update version files
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          sed -i "s/__version__ = \".*\"/__version__ = \"$VERSION\"/" \
            src/electricitymaps_airflow_scheduler/__init__.py
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" pyproject.toml

      - name: Build package
        run: |
          pip install --upgrade pip build -q
          python -m build

      - name: Commit and tag
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          TAG: ${{ steps.version.outputs.TAG }}
        run: |
          git config user.name "electricitymaps-release-bot[bot]"
          git config user.email "electricitymaps-release-bot[bot]@users.noreply.github.com"
          git add src/electricitymaps_airflow_scheduler/__init__.py pyproject.toml
          git commit -m "chore: bump version to $VERSION"
          git tag -a "$TAG" -m "Release $TAG"

      - name: Push
        if: ${{ !inputs.dry_run }}
        env:
          TAG: ${{ steps.version.outputs.TAG }}
        run: |
          git push origin HEAD
          git push origin "$TAG"

      - name: Publish to PyPI
        if: ${{ !inputs.dry_run }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

      - name: Create GitHub release
        if: ${{ !inputs.dry_run }}
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ steps.app-token.outputs.token }}
          tag_name: ${{ steps.version.outputs.TAG }}
          generate_release_notes: true
          files: dist/*

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          TAG: ${{ steps.version.outputs.TAG }}
        run: |
          echo "=== DRY RUN COMPLETE ==="
          echo "Version: $VERSION"
          echo "Tag: $TAG"
          echo "Commit: $(git log -1 --oneline)"
          echo "Artifacts: $(ls dist/)"
