name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.2.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (skip publishing)'
        required: false
        type: boolean
        default: false

env:
  VERSION: ${{ inputs.version }}
  TAG: v${{ inputs.version }}

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version and tag
        run: |
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Version '$VERSION' does not match format X.Y.Z or X.Y.Z-suffix"
            exit 1
          fi
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "::error::Tag $TAG already exists"
            exit 1
          fi
          LATEST=$(git tag -l 'v*' | sort -V | tail -n1 | sed 's/^v//')
          if [[ -n "$LATEST" ]]; then
            HIGHEST=$(printf '%s\n%s' "$LATEST" "$VERSION" | sort -V | tail -n1)
            if [[ "$HIGHEST" != "$VERSION" ]]; then
              echo "::error::Version $VERSION is lower than latest release $LATEST"
              exit 1
            fi
          fi

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Update version files
        run: |
          sed -i "s/__version__ = \".*\"/__version__ = \"$VERSION\"/" \
            src/electricitymaps_airflow_scheduler/__init__.py
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" pyproject.toml

      - name: Build package
        run: |
          pip install --upgrade pip build -q
          python -m build

      - name: Commit and tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/electricitymaps_airflow_scheduler/__init__.py pyproject.toml
          git commit -m "chore: bump version to $VERSION"
          git tag -a "$TAG" -m "Release $TAG"

      - name: Push
        if: ${{ !inputs.dry_run }}
        run: |
          git push origin HEAD
          git push origin "$TAG"

      - name: Publish to PyPI
        if: ${{ !inputs.dry_run }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

      - name: Create GitHub release
        if: ${{ !inputs.dry_run }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          generate_release_notes: true
          files: dist/*

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        run: |
          echo "=== DRY RUN COMPLETE ==="
          echo "Version: $VERSION"
          echo "Tag: $TAG"
          echo "Commit: $(git log -1 --oneline)"
          echo "Artifacts: $(ls dist/)"
